name: release

on:
    push:
      branches-ignore:
      - '**'
      tags:
      - 'v*'
  
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
          - name: Set version
            id: version
            run: |
                REPOSITORY=$(echo ${{ github.repository }} | sed -e "s#.*/##")
                VERSION=$(echo ${{ github.ref }} | sed -e "s#refs/tags/##g")
                echo ::set-output name=version::$VERSION
                echo ::set-output name=filename::$REPOSITORY-$VERSION
                echo "Version $VERSION"                
          - name: Checkout code
            uses: actions/checkout@v2
            with:
                token: ${{ secrets.GITHUB_TOKEN }}
          - name: Archive
            run: |
                cd ./Assets/SimpleUdonPin
                zip -r ${{ steps.version.outputs.filename }}.zip ./ -x "*.git*" ../../
          
          - run: |
                cd ../../
                find "./Assets/SimpleUdonPin" -name \*.meta >> metaList
          - name: Create UnityPackage
            uses: pCYSl5EDgo/create-unitypackage@e28c7a4616b2754c564b0a959a03b3c89b756fdb
            with:
              package-path: "${{ steps.version.outputs.filename }}.unitypackage"
              include-files: metaList
          - name: Create Release
            id: create_release
            uses: actions/create-release@v1
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
                tag_name: ${{ github.ref }}
                release_name: Release ${{ github.ref }}
                draft: false
                prerelease: false
          - name: Upload Release Zip
            uses: actions/upload-release-asset@v1
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
                upload_url: ${{ steps.create_release.outputs.upload_url }}
                asset_path: ./${{ steps.version.outputs.filename }}.zip
                asset_name: ${{ steps.version.outputs.filename }}.zip
                asset_content_type: application/zip
          - name: Upload Release UnityPackage
            uses: actions/upload-release-asset@v1
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
                upload_url: ${{ steps.create_release.outputs.upload_url }}
                asset_path: ./${{ steps.version.outputs.filename }}.unitypackage
                asset_name: ${{ steps.version.outputs.filename }}.unitypackage
                asset_content_type: application/zip
         